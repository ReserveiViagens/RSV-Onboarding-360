# 🐘 POSTGRESQL OTIMIZADO - ONION RSV 360
# Configuração de alta performance para sistema de turismo

# =============================================================================
# CONFIGURAÇÕES BÁSICAS
# =============================================================================

# Versão do PostgreSQL
listen_addresses = '*'
port = 5432
max_connections = 200

# Configurações de memória
shared_buffers = 1GB                    # 25% da RAM (4GB)
effective_cache_size = 3GB              # 75% da RAM disponível
work_mem = 32MB                         # Por operação de sort/hash
maintenance_work_mem = 256MB            # Para VACUUM, CREATE INDEX

# =============================================================================
# CONFIGURAÇÕES DE PERFORMANCE
# =============================================================================

# WAL (Write-Ahead Logging)
wal_level = replica
wal_buffers = 16MB
max_wal_size = 2GB
min_wal_size = 512MB
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9

# Configurações de planner
random_page_cost = 1.1                 # SSD otimizado
effective_io_concurrency = 200         # Concurrent I/O para SSD

# Configurações de autovacuum
autovacuum = on
autovacuum_max_workers = 6
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# =============================================================================
# CONFIGURAÇÕES DE LOGGING
# =============================================================================

# Logging geral
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# Logs de performance
log_min_duration_statement = 1000      # Log queries > 1 segundo
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 10MB

# Logs detalhados
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_statement = 'ddl'                  # Log DDL statements

# =============================================================================
# CONFIGURAÇÕES DE CONEXÃO
# =============================================================================

# Pool de conexões
superuser_reserved_connections = 3
tcp_keepalives_idle = 300
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# Timeouts
statement_timeout = 30min              # 30 minutos para queries longas
lock_timeout = 30s                     # Timeout para locks
idle_in_transaction_session_timeout = 10min

# =============================================================================
# CONFIGURAÇÕES DE BACKUP E REPLICAÇÃO
# =============================================================================

# Archive settings
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/archive/%f'
archive_timeout = 300

# Replication
max_wal_senders = 3
wal_keep_size = 1GB                    # Para replicação (substitui wal_keep_segments)
hot_standby = on
hot_standby_feedback = on

# =============================================================================
# CONFIGURAÇÕES ESPECÍFICAS PARA TURISMO
# =============================================================================

# Timezone para sistema brasileiro
timezone = 'America/Sao_Paulo'
log_timezone = 'America/Sao_Paulo'

# Configurações de locale
lc_messages = 'pt_BR.UTF-8'
lc_monetary = 'pt_BR.UTF-8'
lc_numeric = 'pt_BR.UTF-8'
lc_time = 'pt_BR.UTF-8'

# Configurações de encoding
default_text_search_config = 'pg_catalog.portuguese'

# =============================================================================
# CONFIGURAÇÕES AVANÇADAS DE PERFORMANCE
# =============================================================================

# Parallel processing
max_parallel_workers = 8
max_parallel_workers_per_gather = 4
max_parallel_maintenance_workers = 4

# Background writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# Configurações JIT (Just-In-Time compilation)
jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# =============================================================================
# MONITORAMENTO E ESTATÍSTICAS
# =============================================================================

# Track activities
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Statistics
default_statistics_target = 1000       # Mais estatísticas para melhor planning
auto_explain.log_min_duration = 2000   # Log explain para queries > 2s
auto_explain.log_analyze = on
auto_explain.log_buffers = on

# Extensions para monitoramento
shared_preload_libraries = 'pg_stat_statements,auto_explain'

# =============================================================================
# CONFIGURAÇÕES DE SEGURANÇA
# =============================================================================

# SSL (para produção)
# ssl = on
# ssl_cert_file = '/var/lib/postgresql/server.crt'
# ssl_key_file = '/var/lib/postgresql/server.key'

# Password encryption
password_encryption = scram-sha-256

# Configurações de audit
log_statement_stats = off
log_parser_stats = off
log_planner_stats = off
log_executor_stats = off