# üåê NGINX LOAD BALANCER - ONION RSV 360 (Funcionando)

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/json;
    
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    sendfile on;
    keepalive_timeout 65;
    
    # Headers de seguran√ßa
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # Servidor principal na porta 80
    server {
        listen 80;
        server_name localhost;
        
        # Health check do load balancer
        location /health {
            return 200 '{"status":"healthy","service":"nginx-load-balancer","version":"1.0"}';
            add_header Content-Type application/json;
        }
        
        # Status da API Gateway
        location /api/status {
            return 200 '{"status":"ok","load_balancer":"nginx","services":32,"message":"Load Balancer Active"}';
            add_header Content-Type application/json;
        }
        
        # Core service
        location /core/ {
            proxy_pass http://core:5000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Travel service  
        location /travel/ {
            proxy_pass http://travel:5003/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Finance service
        location /finance/ {
            proxy_pass http://finance:5005/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Tickets service
        location /tickets/ {
            proxy_pass http://tickets:5006/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Attractions service
        location /attractions/ {
            proxy_pass http://attractions:5009/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Payments service
        location /payments/ {
            proxy_pass http://payments:5005/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Ecommerce service
        location /ecommerce/ {
            proxy_pass http://ecommerce:5007/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # P√°gina padr√£o
        location / {
            return 200 '{"message":"Onion RSV 360 API Gateway","load_balancer":"active","services":32,"endpoints":["/health","/api/status","/core/","/travel/","/finance/","/tickets/","/attractions/","/payments/","/ecommerce/"]}';
            add_header Content-Type application/json;
        }
    }
    
    # Servidor de monitoramento na porta 8080
    server {
        listen 8080;
        server_name localhost;
        
        location /health {
            return 200 "nginx monitoring healthy\n";
            add_header Content-Type text/plain;
        }
        
        location /nginx_status {
            stub_status on;
            access_log off;
        }
        
        location / {
            return 200 "Nginx Load Balancer Monitoring - Use /health or /nginx_status\n";
            add_header Content-Type text/plain;
        }
    }
}